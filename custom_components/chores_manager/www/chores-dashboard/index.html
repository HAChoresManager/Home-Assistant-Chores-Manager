<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chores Manager Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="css/styles.css">
    
    <style>
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-left: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #6b7280;
            font-size: 16px;
        }
        
        .error-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
        }
        
        .error-container h2 {
            color: #dc2626;
            margin-bottom: 16px;
            font-size: 24px;
            font-weight: 600;
        }
        
        .error-container p {
            color: #6b7280;
            margin-bottom: 8px;
        }
        
        .error-container button {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .error-container button:hover {
            background: #2563eb;
        }
        
        .error-container ul {
            margin: 16px 0;
            padding-left: 20px;
        }
        
        .error-container li {
            margin: 4px 0;
            color: #dc2626;
        }
    </style>

    <script>
        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);
            
            const rootElement = document.getElementById('root');
            if (rootElement && !rootElement.querySelector('.error-container')) {
                rootElement.innerHTML = `
                    <div class="error-container">
                        <h2>Application Error</h2>
                        <p>An unexpected error occurred: ${event.error ? event.error.message : 'Unknown error'}</p>
                        <pre>${event.error ? event.error.stack : ''}</pre>
                        <button onclick="window.location.reload()" style="margin-top: 10px; padding: 5px 10px;">Reload Page</button>
                    </div>`;
            }
        });

        // Add version info to global object
        window.CHORES_APP_VERSION = "1.4.1-20250415-flickerfix";
        console.log('Chores Dashboard Version:', window.CHORES_APP_VERSION);
    </script>
</head>
<body>
    <div id="root">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading dashboard...</div>
        </div>
    </div>

    <!-- Load React first -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>

    <!-- Load core utilities and helpers -->
    <script src="js/auth-helper.js?v=20250415-flickerfix" type="text/javascript"></script>
    <script src="js/utils.js?v=20250415-flickerfix" type="text/javascript"></script>
    <script src="js/theme-integration.js?v=20250415-flickerfix" type="text/javascript"></script>

    <!-- Load modular API layer with proper sequencing -->
    <script type="text/javascript">
        // Ensure all API modules are loaded in the correct sequence
        (function() {
            'use strict';
            
            // Function to load a script dynamically
            function loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.type = 'text/javascript';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
            
            // Function to load API modules in sequence
            async function loadAPIModules() {
                try {
                    console.log('Starting API module loading sequence...');
                    
                    // Step 1: Load base.js first (defines BaseAPI, ENDPOINTS)
                    console.log('Loading base.js...');
                    await loadScript('js/api/base.js?v=20250415-flickerfix');
                    
                    // Step 2: Wait for BaseAPI to be available
                    let attempts = 0;
                    const maxAttempts = 50;
                    
                    while ((!window.ChoresAPI || !window.ChoresAPI.BaseAPI) && attempts < maxAttempts) {
                        attempts++;
                        console.log(`Waiting for BaseAPI... attempt ${attempts}/${maxAttempts}`);
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    if (!window.ChoresAPI || !window.ChoresAPI.BaseAPI) {
                        throw new Error('BaseAPI not loaded after ' + maxAttempts + ' attempts');
                    }
                    
                    console.log('BaseAPI confirmed loaded, loading dependent modules...');
                    
                    // Step 3: Load API modules in sequence (these depend on BaseAPI)
                    await loadScript('js/api/chores.js?v=20250415-flickerfix');
                    console.log('chores.js loaded');
                    
                    await loadScript('js/api/users.js?v=20250415-flickerfix');
                    console.log('users.js loaded');
                    
                    await loadScript('js/api/theme.js?v=20250415-flickerfix');
                    console.log('theme.js loaded');
                    
                    // Step 4: Load index.js last (combines all APIs)
                    await loadScript('js/api/index.js?v=20250415-flickerfix');
                    console.log('index.js loaded');
                    
                    // Step 5: Wait for final API to be initialized
                    attempts = 0;
                    while ((!window.ChoresAPI || !window.ChoresAPI.initialize) && attempts < maxAttempts) {
                        attempts++;
                        console.log(`Waiting for ChoresAPI initialization... attempt ${attempts}/${maxAttempts}`);
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    console.log('All API modules loaded successfully');
                    
                } catch (error) {
                    console.error('Error loading API modules:', error);
                    document.getElementById('root').innerHTML = `
                        <div class="error-container">
                            <h2>API Loading Error</h2>
                            <p>Failed to load API modules: ${error.message}</p>
                            <p>Please check the browser console for more details.</p>
                            <button onclick="window.location.reload()" style="margin-top: 10px; padding: 5px 10px;">Reload Page</button>
                        </div>`;
                }
            }
            
            // Start loading API modules
            loadAPIModules();
        })();
    </script>

    <!-- Load components sequentially to respect dependencies -->
    <script type="text/javascript">
        (function() {
            'use strict';

            const componentLoadOrder = [
                'js/components/fallback.js',
                'js/components/base.js',
                'js/components/error-boundary.js',
                'js/components/dialogs.js',
                'js/components/forms.js',
                'js/components/stats.js',
                'js/components/tasks.js'
            ];

            function loadSequentially(index = 0) {
                if (index >= componentLoadOrder.length) {
                    window.dispatchEvent(new CustomEvent('chores-components-ready', {
                        detail: { components: Object.keys(window.choreComponents || {}) }
                    }));
                    return;
                }

                const script = document.createElement('script');
                const version = window.CHORES_APP_VERSION ? `?v=${window.CHORES_APP_VERSION}` : '';
                script.src = componentLoadOrder[index] + version;
                script.type = 'text/javascript';
                script.onload = () => loadSequentially(index + 1);
                script.onerror = () => loadSequentially(index + 1);
                document.head.appendChild(script);
            }

            loadSequentially();
        })();
    </script>

    <!-- Load app modules in correct order -->
    <script src="js/app-state.js?v=20250415-flickerfix" type="text/javascript"></script>
    <script src="js/app-handlers.js?v=20250415-flickerfix" type="text/javascript"></script>
    <script src="js/app-init.js?v=20250415-flickerfix" type="text/javascript"></script>

    <!-- Load the main app last -->
    <script src="js/app.js?v=20250415-flickerfix" type="text/javascript"></script>

    <script type="text/javascript">
        // Initialize app when all dependencies are loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, waiting for dependencies...');

            let initAttempts = 0;
            const maxAttempts = 50; // 5 seconds total
            
            function checkDependenciesAndInit() {
                initAttempts++;

                // Check what's missing
                const missing = [];
                if (!window.React) missing.push('React');
                if (!window.ReactDOM) missing.push('ReactDOM');
                if (!window.choreUtils) missing.push('choreUtils');
                if (!window.choreComponents) missing.push('choreComponents');
                if (!window.ChoresApp) missing.push('ChoresApp');
                if (window.ChoresApp && typeof window.ChoresApp.initApp !== 'function') missing.push('ChoresApp.initApp');
                if (!window.ChoresAPI) missing.push('ChoresAPI');
                if (window.ChoresAPI && !window.ChoresAPI.ENDPOINTS) missing.push('ChoresAPI.ENDPOINTS');

                if (missing.length === 0) {
                    // All dependencies loaded, initialize the app
                    console.log('All dependencies loaded, initializing app...');
                    try {
                        if (window.ChoresApp && typeof window.ChoresApp.initApp === 'function') {
                            window.ChoresApp.initApp();
                        } else {
                            throw new Error('ChoresApp.initApp not available');
                        }
                    } catch (error) {
                        console.error('Failed to initialize ChoresApp:', error);
                        document.getElementById('root').innerHTML = `
                            <div class="error-container">
                                <h2>Initialization Error</h2>
                                <p>Failed to initialize the application: ${error.message}</p>
                                <button onclick="window.location.reload()" style="margin-top: 10px; padding: 5px 10px;">Reload Page</button>
                            </div>`;
                    }
                    return;
                }

                if (initAttempts < maxAttempts) {
                    console.log(`Still loading... Missing: ${missing.join(', ')}`);
                }

                // If we've exceeded max attempts, show error
                if (initAttempts >= maxAttempts) {
                    console.error('Failed to load dependencies after ' + maxAttempts + ' attempts');
                    console.error('Missing dependencies:', missing);
                    const rootElement = document.getElementById('root');
                    if (rootElement) {
                        rootElement.innerHTML = `
                            <div class="error-container" style="padding: 20px;">
                                <h2>Loading Error</h2>
                                <p>Failed to load required dependencies:</p>
                                <ul style="text-align: left;">
                                    ${missing.map(dep => `<li>${dep}</li>`).join('')}
                                </ul>
                                <p>Please check the browser console for more details.</p>
                                <button onclick="window.location.reload()" style="margin-top: 10px; padding: 5px 10px;">
                                    Reload Page
                                </button>
                            </div>`;
                    }
                    return;
                }

                // Continue checking
                setTimeout(checkDependenciesAndInit, 100);
            }

            // Start checking dependencies
            checkDependenciesAndInit();
        });
    </script>
</body>
</html>